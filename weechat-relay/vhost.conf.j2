map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

upstream weechat-{{ username }} {
    server 127.0.0.1:{{ port }};
}

limit_req_zone $binary_remote_addr zone=weechat-{{ username }}:10m rate=5r/m;

server {

  listen 80;
  server_name {{ username }}.irc.urlab.be;

  location /weechat {
      proxy_pass http://weechat-{{ username }};
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_read_timeout 604800;
      proxy_buffering off;
      proxy_set_header X-Real-IP $remote_addr;
      limit_req zone=weechat-{{ username }} burst=1 nodelay;
  }

}

